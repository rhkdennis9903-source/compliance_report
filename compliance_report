import streamlit as st
import os
import google.generativeai as genai
from dotenv import load_dotenv
import PyPDF2
from io import StringIO

# --- è¨­å®šé é¢é…ç½® ---
st.set_page_config(
    page_title="AI æ–‡æ¡ˆæ³•è¦åˆè¦æ€§æª¢æ¸¬åŠ©æ‰‹",
    page_icon="âš–ï¸",
    layout="wide"
)

# --- å´é‚Šæ¬„ï¼šè¨­å®šèˆ‡ API Key ---
with st.sidebar:
    st.header("âš™ï¸ è¨­å®š")
    
    # å˜—è©¦å¾ç’°å¢ƒè®Šæ•¸è®€å– API Keyï¼Œå¦‚æœæ²’æœ‰å‰‡é¡¯ç¤ºè¼¸å…¥æ¡†
    load_dotenv()
    env_api_key = os.getenv("GOOGLE_API_KEY")
    
    api_key = st.text_input(
        "è¼¸å…¥ Google Gemini API Key",
        value=env_api_key if env_api_key else "",
        type="password",
        help="è«‹è¼¸å…¥æ‚¨çš„ Gemini API Key ä»¥å•Ÿå‹•æœå‹™"
    )

    st.markdown("---")
    st.info(
        "**ä½¿ç”¨æ¨¡å‹ï¼š**\n"
        "å„ªå…ˆï¼šGemini 3 Pro Preview\n"
        "å‚™æ´ï¼šGemini 2.5 Pro\n\n"
        "**æª¢æ¸¬ç¯„åœï¼š**\n"
        "1. å°ç£æ³•è¦ (å…¬å¹³æœƒã€è¡›ç”Ÿå±€)\n"
        "2. æ‚¨ä¸Šå‚³çš„å…§éƒ¨è¦ç¯„"
    )

# --- æ ¸å¿ƒåŠŸèƒ½å‡½å¼ ---

def extract_text_from_file(uploaded_file):
    """å¾ä¸Šå‚³çš„æª”æ¡ˆ (TXT, PDF) ä¸­æå–æ–‡å­—"""
    if uploaded_file is None:
        return ""
    
    try:
        if uploaded_file.type == "application/pdf":
            reader = PyPDF2.PdfReader(uploaded_file)
            text = ""
            for page in reader.pages:
                text += page.extract_text() + "\n"
            return text
        
        elif uploaded_file.type == "text/plain":
            stringio = StringIO(uploaded_file.getvalue().decode("utf-8"))
            return stringio.read()
        
        else:
            st.error("ç›®å‰åƒ…æ”¯æ´ PDF èˆ‡ TXT æ ¼å¼")
            return ""
    except Exception as e:
        st.error(f"æª”æ¡ˆè®€å–å¤±æ•—: {e}")
        return ""

def analyze_compliance(api_key, ad_copy, reference_data):
    """å‘¼å« Gemini é€²è¡Œæ³•è¦æ¯”å°"""
    if not api_key:
        st.error("è«‹å…ˆè¼¸å…¥ API Key")
        return None

    genai.configure(api_key=api_key)

    # æ¨¡å‹è·¯ç”±é‚è¼¯ï¼šå„ªå…ˆä½¿ç”¨ 3-pro-preview
    # æ³¨æ„ï¼šå¯¦éš›ä½¿ç”¨æ™‚éœ€ç¢ºèªå¸³è™Ÿæ˜¯å¦æœ‰æ¬Šé™å­˜å– preview æ¨¡å‹ï¼Œå¦å‰‡æœƒ fallback
    model_name = "gemini-3-pro-preview" 
    
    try:
        # å»ºç«‹ç³»çµ±æç¤ºè© (System Instruction)
        # é€™è£¡è¨­å®š AI ç‚ºå°ç£æ³•è¦å°ˆå®¶
        system_instruction = """
        ä½ æ˜¯ä¸€ä½ç²¾é€šå°ç£æ³•è¦çš„ã€Œé¦–å¸­åˆè¦é•· (Chief Compliance Officer)ã€ã€‚
        ä½ çš„å°ˆé•·é ˜åŸŸåŒ…å«ï¼š
        1. ã€Šå…¬å¹³äº¤æ˜“æ³•ã€‹ï¼ˆä¸å¯¦å»£å‘Šã€èª‡å¤§ä¸å¯¦ï¼‰
        2. ã€Šæ¶ˆè²»è€…ä¿è­·æ³•ã€‹
        3. ç‰¹æ®Šç”¢æ¥­æ³•è¦ï¼šå¦‚ã€Šè—¥äº‹æ³•ã€‹ã€ã€Šé†«ç™‚å™¨æç®¡ç†æ³•ã€‹ã€ã€ŠåŒ–ç²§å“è¡›ç”Ÿå®‰å…¨ç®¡ç†æ³•ã€‹ã€ã€Šé£Ÿå“å®‰å…¨è¡›ç”Ÿç®¡ç†æ³•ã€‹ã€‚
        
        ä½ çš„ä»»å‹™æ˜¯å¯©æ ¸ä½¿ç”¨è€…çš„è¡ŒéŠ·æ–‡æ¡ˆï¼Œä¸¦é€²è¡Œé¢¨éšªè©•ä¼°ã€‚
        ä½ å¿…é ˆæ¥µåº¦åš´è¬¹ï¼Œå°æ–¼ã€Œç™‚æ•ˆã€ã€ã€Œä¿è­‰ã€ã€ã€Œç¬¬ä¸€ã€ã€ã€Œå”¯ä¸€ã€ç­‰æ•æ„Ÿè©å½™ä¿æŒé«˜åº¦è­¦æˆ’ã€‚
        """

        model = genai.GenerativeModel(
            model_name=model_name,
            system_instruction=system_instruction
        )
        
        # æ§‹å»º Prompt
        prompt = f"""
        è«‹é‡å°ä»¥ä¸‹ã€å¾…å¯©æ ¸æ–‡æ¡ˆã€‘ï¼Œä¾æ“šã€å°ç£æ³•è¦çŸ¥è­˜ã€‘ä»¥åŠã€ä½¿ç”¨è€…æä¾›çš„åƒè€ƒè³‡æ–™ï¼ˆè‹¥æœ‰ï¼‰ã€‘é€²è¡Œåˆè¦æ€§åˆ†æã€‚

        ### 1. ä½¿ç”¨è€…æä¾›çš„åƒè€ƒè³‡æ–™ (å…§éƒ¨è¦ç¯„/éå¾€æ¡ˆä¾‹)ï¼š
        {reference_data if reference_data else "ç„¡æä¾›åƒè€ƒè³‡æ–™ï¼Œè«‹å®Œå…¨ä¾æ“šå°ç£æ³•è¦åˆ¤æ–·ã€‚"}

        ### 2. å¾…å¯©æ ¸æ–‡æ¡ˆï¼š
        {ad_copy}

        ---
        ### è«‹è¼¸å‡ºåˆ†æå ±å‘Šï¼ˆä½¿ç”¨ Markdown æ ¼å¼ï¼‰ï¼š

        1.  **ç¸½é«”é¢¨éšªè©•ç´š**ï¼š(ä½ / ä¸­ / é«˜ / æ¥µé«˜)
        2.  **é—œéµé•è¦ç†±é»åˆ†æ**ï¼š
            * è«‹é€æ¢åˆ—å‡ºæ–‡æ¡ˆä¸­å¯èƒ½é•è¦çš„å¥å­æˆ–è©å½™ã€‚
            * å¼•ç”¨ç›¸é—œæ³•è¦ï¼ˆä¾‹å¦‚ï¼šã€Œé•åé£Ÿå“å®‰å…¨è¡›ç”Ÿç®¡ç†æ³•ç¬¬28æ¢ï¼Œé£Ÿå“ä¸å¾—å®£ç¨±é†«ç™‚æ•ˆèƒ½ã€ï¼‰ã€‚
            * è‹¥é•åã€åƒè€ƒè³‡æ–™ã€‘ä¸­çš„å…§éƒ¨è¦å®šï¼Œä¹Ÿè«‹æŒ‡å‡ºã€‚
        3.  **ä¿®æ”¹å»ºè­°**ï¼š
            * é‡å°æ¯ä¸€å€‹é•è¦é»ï¼Œæä¾›å…·é«”çš„ä¿®æ”¹å»ºè­°æˆ–æ˜¯ã€Œå®‰å…¨æ›¿ä»£è©å½™ã€ã€‚
        4.  **è¡ŒéŠ·é‚è¼¯æª¢è¦–**ï¼š
            * åœ¨åˆè¦çš„å‰æä¸‹ï¼Œé€™äº›ä¿®æ”¹æ˜¯å¦ä¿ç•™äº†è¡ŒéŠ·åŠ›åº¦ï¼Ÿå¦‚æœæ²’æœ‰ï¼Œè«‹æä¾›æ›´æœ‰èªªæœåŠ›ä¸”åˆè¦çš„å¯«æ³•ã€‚
        """

        # è¨­å®šç”Ÿæˆåƒæ•¸ (é™ä½éš¨æ©Ÿæ€§ï¼Œæé«˜åˆ†æç²¾æº–åº¦)
        generation_config = genai.types.GenerationConfig(
            temperature=0.2,
            top_p=0.8,
            top_k=40
        )

        with st.spinner(f"æ­£åœ¨ä½¿ç”¨ {model_name} é€²è¡Œæ·±åº¦æ³•è¦æ¨ç†..."):
            response = model.generate_content(prompt, generation_config=generation_config)
            return response.text

    except Exception as e:
        # è‹¥ 3-pro-preview å¤±æ•— (ä¾‹å¦‚æ¬Šé™å•é¡Œ)ï¼Œå˜—è©¦ fallback åˆ° gemini-2.5-pro
        if "404" in str(e) or "not found" in str(e).lower():
            try:
                fallback_model = "gemini-2.5-pro"
                st.warning(f"{model_name} ç„¡æ³•å­˜å–ï¼Œåˆ‡æ›è‡³ {fallback_model} é€²è¡Œåˆ†æ...")
                model = genai.GenerativeModel(fallback_model, system_instruction=system_instruction)
                response = model.generate_content(prompt, generation_config=generation_config)
                return response.text
            except Exception as e2:
                st.error(f"åˆ†æç™¼ç”ŸéŒ¯èª¤: {str(e2)}")
                return None
        else:
            st.error(f"åˆ†æç™¼ç”ŸéŒ¯èª¤: {str(e)}")
            return None

# --- ä¸»ä»‹é¢ ---

st.title("ğŸ›¡ï¸ å°ç£è¡ŒéŠ·æ–‡æ¡ˆæ³•è¦å¿«ç¯©ç³»çµ±")
st.markdown("åˆ©ç”¨ **Gemini 3 Pro** çš„å¼·å¤§æ¨ç†èƒ½åŠ›ï¼Œæ¯”å° **å°ç£ç¾è¡Œæ³•è¦** èˆ‡æ‚¨çš„ **å…§éƒ¨è³‡æ–™åº«**ã€‚")

col1, col2 = st.columns([1, 1])

with col1:
    st.subheader("1. è¼¸å…¥å¾…å¯©æ ¸æ–‡æ¡ˆ")
    
    input_method = st.radio("è¼¸å…¥æ–¹å¼", ["ç›´æ¥è²¼ä¸Šæ–‡å­—", "ä¸Šå‚³æ–‡æ¡ˆæª”æ¡ˆ"], horizontal=True)
    
    ad_copy_text = ""
    
    if input_method == "ç›´æ¥è²¼ä¸Šæ–‡å­—":
        ad_copy_text = st.text_area("è«‹åœ¨æ­¤è²¼ä¸Šæ–‡æ¡ˆå…§å®¹", height=300, placeholder="ä¾‹å¦‚ï¼šé€™æ¬¾ç›Šç”ŸèŒèƒ½æœ‰æ•ˆæ²»ç™‚éæ•ï¼Œä¿è­‰ä¸‰å¤©è¦‹æ•ˆ...")
    else:
        ad_file = st.file_uploader("ä¸Šå‚³æ–‡æ¡ˆ (TXT/PDF)", type=["txt", "pdf"], key="ad_file")
        if ad_file:
            ad_copy_text = extract_text_from_file(ad_file)
            st.success(f"å·²è®€å–æ–‡æ¡ˆï¼Œé•·åº¦ï¼š{len(ad_copy_text)} å­—")

with col2:
    st.subheader("2. æä¾›åƒè€ƒè³‡æ–™åº« (é¸å¡«)")
    st.markdown("æ‚¨å¯ä»¥ä¸Šå‚³ï¼šéå¾€å¯©æ ¸éçš„ Pass æ¡ˆä¾‹ã€å…¬å¸å…§éƒ¨çš„ Brand Guidelinesã€æˆ–ç‰¹å®šçš„æ³•è¦å‚™å¿˜éŒ„ã€‚")
    
    ref_file = st.file_uploader("ä¸Šå‚³åƒè€ƒè³‡æ–™ (TXT/PDF)", type=["txt", "pdf"], key="ref_file")
    ref_text = ""
    
    if ref_file:
        ref_text = extract_text_from_file(ref_file)
        with st.expander("é è¦½åƒè€ƒè³‡æ–™å…§å®¹"):
            st.text(ref_text[:500] + "...")

# --- åŸ·è¡ŒæŒ‰éˆ• ---
st.markdown("---")
if st.button("ğŸš€ é–‹å§‹æ³•è¦åˆè¦æ€§åˆ†æ", type="primary", use_container_width=True):
    if not ad_copy_text:
        st.warning("âš ï¸ è«‹å‹™å¿…æä¾›ã€Œå¾…å¯©æ ¸æ–‡æ¡ˆã€")
    else:
        result = analyze_compliance(api_key, ad_copy_text, ref_text)
        if result:
            st.markdown("## ğŸ“‹ åˆ†æå ±å‘Š")
            st.markdown(result)
            
            # æä¾›ä¸‹è¼‰å ±å‘Šçš„åŠŸèƒ½
            st.download_button(
                label="ğŸ“¥ ä¸‹è¼‰åˆ†æå ±å‘Š (TXT)",
                data=result,
                file_name="compliance_report.md",
                mime="text/markdown"
            )
